<!doctype html>
<html>
	<head>
		<script src='/socket.io/socket.io.js'></script>
		<script>
			var clientid = 0;
			var blestatus = 0;
			var socket = io();
			const BTSERIAL_STATUS = ["bluetooth disconnected", "bluetooth connected",
									 "bluetooth paired, but not connected", "bluetooth connect error"];

			socket.on('welcome', data => {
				clientid=data.id;
				document.getElementById("clientid").innerHTML = 'Client ID: ' + clientid;
			});

			socket.on('status', data => {
				blestatus = data.blestatus;
				document.getElementById("blestatus").innerHTML = 'Bluetooth Status:' + BTSERIAL_STATUS[blestatus];
			});

			/*socket.on('feedback', data => {
				document.getElementById("feedback").innerHTML = 'FeedBack: ' + data.feedback;
			});*/

			document.onkeydown = checkKey;
			function checkKey(e) {
				e = e || window.event;
				if (e.keyCode == '37' || e.keyCode == '38' || e.keyCode == '39' || 
						e.keyCode == '40' || e.keyCode == '83') {
					// 37: LEFT arrow, 38: Up arrow, 39: RIGHT arrow, 40: DOWN arror, 83: S key
					socket.emit('keypress', { id: clientid, key: e.keyCode });
				}
				else if (e.keyCode == '67') {
					//67: C Key , clear screen
					init();
				}
			}

			var context;
			var oldx=50;
			var oldy=50;
			var botx=50;
			var boty=250;
			var botspeedx=1;
			var botspeedy=1;

			function init()
			{
			  context = myCanvas.getContext('2d');
			  context.clearRect(0, 0, 800, 400);
			}

			function clearpoint(x, y, redius) {
			  context.beginPath();
			  context.clearRect(x - redius, y - redius, redius * 2, redius * 2);
			  context.closePath();
			}

			function drawpoint(x, y, redius) {  
			  context.fillStyle="blue";
			  context.beginPath();
				context.arc(x-redius*2,y-redius*2,redius,0,Math.PI*2,true);
			  context.closePath();
			  context.fill();
			  oldx=x-redius*2; oldy=y-redius*2;
			}

			function drawbot(x, y, redius) {  
			  context.fillStyle="red";
			  context.beginPath();
				context.arc(x-redius*2,y-redius*2,redius,0,Math.PI*2,true);
			  context.closePath();
			  context.fill();
			}

			function marklocation(event) {
			  clearpoint(oldx, oldy, 5);
			  drawpoint(event.clientX, event.clientY, 5);
			  changespeed(); 
			}

			function changespeed() {
			  if(oldx>botx) 
				botspeedx =1;
			  else
				botspeedx =-1;
			  if(oldy>boty) 
				botspeedy =1;
			  else
				botspeedy =-1;
			}

			function drivebot()
			{
			  drawbot(botx, boty, 3, "red");
			  botx+=botspeedx;
			  boty+=botspeedy;
			}
			// Send current time every 1 secs
			setInterval(drivebot, 1000);

		</script>
	</head>
	<body onLoad="init();">
		<div onclick="marklocation(event)">
		<canvas id="myCanvas" width="800" height="400" style="border: 1px solid black;"> </canvas>
		<ul id='messages'></ul>
		<p id="clientid">Client ID: clientid</p>
		<p id="blestatus">Status: Blue Tooth Status</p>
	</body>
</html>